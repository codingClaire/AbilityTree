# 5 存储器层次结构
## 5.1 引言
局部性原理
* 时间局部性  
某个数据项被访问 不久的将来也可能再次被访问

* 空间局部性  
如果某个数据项被访问 那么与它相邻的数据项

利用局部性原理将计算机存储器组织成为存储器层次结构  
存储器层次结构由不同速度和容量的多级存储器构成  

**存储器层次结构** 一种由多存储器层次组成的结构  
存储器的容量和访问时间随着距离处理器距离的增加而增加  


存储器层次结构由多层构成 **数据每次只能在相邻的两个层次之间复制**
高层的存储器靠近处理器 比低层存储器容量小 访问速度更快 成本更高

**块（行）: 将一个两级层次结构种存储信息交换的最小单元**

磁盘 DRAM SRAM

**命中** 处理器需要的数据存放在高层存储器中的某个块中 称为一次命中  
**缺失** 在高层存储器中没有找到所需要的数据 这次数据请求称为缺失  

**命中率（命中比率）** 在高层存储器中找到数据的存储访问比例  
**衡量存储器层次结构性能的标准**  
**缺失率**=1-命中率

**命中时间** 访问存储器层次结构中高层存储器所需要的时间  
包括判断当前访问时命中还是缺失所需的时间  
**缺失代价** 将相应的块 从低层存储器替换到高层存储器中  
以及将该信息块传送给处理器的时间之和  
包括**访问块  将数据逐层传输  将数据插入发生缺失的层 将信息块传送给请求者**的时间

较高存储器层次 容量小 选择快速的存储器部件  命中时间要少得多

***

## 5.2 存储器技术

四种技术
* **DRAM** 动态随机存取存储器 主存储器
* **SRAM** 静态随机存取存储器 cache
* **闪存** 非易失性存储器 个人移动设备的二级存储器
* **磁盘** 服务器中容量最大 速度最慢

### 5.2.1 SRAM技术
**利用双稳态触发器存储信息**

* 组织成存储列阵结构的简单集成电路
* 有一个读写端口
* 对任何数据访问时间都是固定的
* 不需要刷新
* 访问速度和周期时间非常相近
* 一个基本存储单元--->6-8个晶体管组成
* 空闲状态下 SRAM 只需要最小的功率来保持电荷

### 5.2.2 DRAM技术
**依靠电容存储电荷的原理存储信息**
* **写  
字线（wordline）设为高电平，设置位线（bitline）为高（写“1”），或为低（写“0”）**
* **读  
位线先预充电（在高低电平之间）,字线设为高电平，Sense Amp根据位线电位的变化，读1/0**

* 使用电容保存电荷的方式来存储数据
* 使用1个晶体管堆该电容进行访问
* 存储每一位都用只用1个晶体管 密度比SRAM要高 价格更便宜
* 在电容上保存电荷 不能长久地保存数据
* 必须周期性刷新（因此叫动态）
>DRAM是依靠电容上存储电荷来暂存信息。平时无电源供电，时间一长电容上存储的电荷会逐渐泄露。需定期向电容补充电荷，以保持信息不变，即为刷新。

每个比特位 需要独立的读出后写回 必须不停的进行刷新操作  
解决方法：**采用两级译码结构**
在一个读周期后紧跟一个写周期的方式 一次刷新一行

**同步DRAM**
增加时钟  简写为SDRAM 使用时钟堆存储器和处理器保持同步  

### 5.2.3 闪存
* 闪存的写操作 可以是存储位损耗
* 损耗均衡 控制器 将写操作从已经写入很多次的块中映射到写入次数较少的块  


### 5.2.4 磁盘存储器
* 读写磁头：为了对磁盘上的信息进行读写 每层的表面有一个包含小的电磁线圈的读写磁头
* 磁道：每个磁盘的表面划分为同心圆盘 称为磁道  
* 扇区：每条磁道同样被划分为用于存储信息的扇区
* 每个扇区的容量：512-4096
* 信息在磁介质上保存的顺序为  
**扇区号 一个间隙 包含该扇区纠错码的信息 一个间隙 下一扇区的扇区号**
* 柱面
* 寻道
* 旋转延时
* 平均旋转延时

磁盘和半导体存储器技术的主要差别：磁盘的访问速度慢
磁盘也是非易失的 但不存在写损耗问题

***
## 5.3 cache的基本原理
处理器每次请求一个字 每个块也是由一个单独的字组成
> 要访问的数据项最初不在cache中  
请求导致了一次缺失 X<sub>n</sub>被从主存调入cache之中

* 怎么知道数据项是否在cache中？
* 怎么在cache中找到数据？


在cache中为主存中的每个字分配一个位置
#### 直接映射
主存地址和cache位置之间的映射：
(块地址) mod (cache中的块数)

00000-11111 主存地址  
000-111 cache    
X 被映射到直接映射cache字 X mod 8  
低log(2)8=3位被用作cache索引  

|地址|
|:--:|
|00001|
|01001|
|10001|
|11001|

都对应于cache中第001块

cache中增加一组标记   
**标记包含地址信息**  
标记：表中的一个字段 包含了地址信息 这些地址信息可以用来判断cache中的字是否就是请求的字  
标记只包含地址的高位 也就是没有用来检索cache的那些位  

处理器启动时 cache中没有数据 标记域中的值没有意义
cache中的一些块依然为空
增加一个有效位  
**有效位** 表中的一个字段 用来标识一个块是否有一个有效数据  

直接映射cache中 只有一个位置可以存放最新请求的数据项 对于哪个数据项被替换 只有一种选择  

**标记域:用来与cache中标记域的值进行比较  
cache索引：用来选择块**

cache块的索引以及标--->唯一确定了cache块中存放内容的主存地址  


### 5.3.1 cache访问
32位地址

|32-12|11-2|1 0|
|:---:|:---:|:----:|
|标记(20位)|索引cache(10位)|字节偏移|

cache 存储了数据和标记位  
所需的位数是cache大小和地址位数的函数  
* 32位地址
* 直接映射cache
* cache的大小必须是2的幂 2^n n位被用来检索
* 块大小是2^m个字 2^(m+2)个字节
m位用于查找块中的字 两位是字节偏移信息  
32-n-m-2

直接映射的cache总位数=2^n*(块大小+标记域大小+有效位域大小)

>**cache 2^12个字 块大小为4个字 地址为32位  
cache总共需要几位？**    
cache的块数为2^12/2^2=2^10   
10位用来检索  
2^10·(4·32+（32-10-2-2）+1)=2^10·147=147Kb=18.4KB  

 > **一个cache中有64块 每块大小为16字节 字节地址1200将被映射到cache中的哪一位？**  
>
 >法1：字节地址1200 转换为二进制 100 1011 0000  
 每一块大小是16字节 2^4 因此m=4  
 cache的块数 n=6  001011 是块号 也就是索引位  
 也就是说被映射到了cache中块号是11的块上
 >
 >法2： **块地址=字节地址/每块的字节数**  
 这个块包含了所有**[字节地址/每块字节数*每块字节数**---**字节地址/每块字节数*每块字节数+(每块字节数-1)**]
 >
 >1200/16=75 对应的块地址位75  
 对应于cache中的块号(75 mod 64)=11

降低缺失率
* 较大的cache块可以更好地利用空间局部性
* 增加块大小

### 5.3.2 cache缺失处理
控制单元 如何处理cache缺失？
控制单元必须能检测到缺失的发生  
从主存中取回所需的数据来处理缺失  

cache缺失处理
* 处理器控制单元
* 一个进行初始化主存访问 重新填充cache的独立控制器  

cache缺失引起--->流水线阻塞  
整个处理器阻塞 临时寄存器和可见的寄存器中的内容被冻结  

两种缺失
* 数据缺失
* 指令缺失

指令缺失处理：  
* 把程序计数器（PC）的原始值（当前PC-4）送到存储器中
* 通知主存执行一次读操作，并等待主存访问完成
* 写cache项，将主存取回的数据写入cache 中，并将地址的高位写入标记域，设置有效位。
* 重启指令执行第一步，重新取指，这次该指令在cache中。

数据缺失处理：
与指令缺失的控制基本相同，发生缺失时，处理器发生阻塞，直到从存储器中取回数据后才响应。


### 5.3.3 写操作处理
写策略：
#### 写直达法（Write-through）
也叫写贯穿法  
当CPU进行写操作时  
在写Cache的同时也将内容写入到相应的主存单元中  
即两个内容同时改写
#### 写回法（Write-back）
* 是当CPU写数据时，只写Cache，不写主存
* 当已改写的块被替换出Cache 时，将其内容写回主存
* Cache 中每块增设“改写位”。

##### 两种方案比较
 * （1）写直达法是在每次写Cache时都有写主存的操作，能始终保持数据块的一致性。

 写回法则仅在数据块被置换时写入主存，可**减少访问主存的开销**，但存在Cache块与主存块的瞬间不一致。

* （2）**写直达法** 一次写入一个字 仅需一个奇/偶校验位 **写回法** 一次写入一个数据块 需要多个校验位
* （3）写直达法需要**较多的缓冲寄存器**存放需要写入主存的数据；而写回法相应要简单些。

### 5.3.4 例子

***
## 5.4 cache性能的评估和改进
CPU时间计算公式
阻塞时间 访问cache缺失的时间代价 PPT

P272 AMAT

替换算法 PPT

### 5.4.1 通过更灵活地放置块来减少cache缺失
### 5.4.2 在cache中查找一个块
### 5.4.3 替换块的选择
全相联中 所有的块都可能被替换掉  

最长用的方法**最近最少使用**  

### 5.4.4 使用多级cache结构减少缺失代价
### 5.4.5 通过分块进行软件优化

***
## 5.5 可信存储器层次
码距  海明校验 奇偶校验
### 5.5.1 失效的定义

### 5.5.2 纠正一位错 检测两位错的汉明编码
汉明距离：两个等长的数对应位置不同位的数量  

**错误检测编码**  

#### **奇偶校验码**
奇偶校验中计算码字中1的数量是奇数个还是偶数个  
如果码距为2 说明错误  
计算出的奇偶校验码和保存的不同  
原来的字有错误  

**一位奇偶校验码主要用于检验1位出错**


#### **汉明纠错码**
码距为3  
* 从1开始编号
* 将所有编号为2的整数次幂作为奇偶校验位  
* 第i位校验二进制右边第i位为1的数

1 检查1，3，5，7，9
2 检查2，3，6，7，10，11
4 检查4，5，6，7，12，13
8 检查 8，9，10，11，12

以下见prepareforTest.md
***
## 5.6 虚拟机
### 5.6.1 虚拟机监视器的必备条件
### 5.6.2 指令集系统结构缺乏对虚拟机的支持
### 5.6.3 保护和指令集系统结构
***
## 5.7 虚拟存储器

### 5.7.1 页的存放和查找
### 5.7.2  缺页故障
### 5.7.3 关于写
### 5.7.4 加快地址转换：TLB
### 5.7.5 集成虚拟存储器、TLB和cache
### 5.7.6 虚拟存储器中的保护
### 5.7.7 处理TLB缺失和缺页
